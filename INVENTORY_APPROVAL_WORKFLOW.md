# Inventory Approval Workflow Implementation

## Overview
This feature implements a **delayed inventory decrease** workflow where book copies are NOT deducted from inventory until the rental is **approved by admin/staff**. This prevents inventory issues during the pending approval process.

## Changes Made

### 1. **Rental.php Model** - Core Logic Updates

#### Removed Immediate Inventory Decrease
- **Before**: `rentBook()` called `bookModel->markRented()` immediately upon rental creation
- **After**: `rentBook()` NO LONGER decreases inventory - rental created with `status='pending'`

#### New Method: `approveRental($rentalId)`
```php
public function approveRental($rentalId)
{
    // Get rental details
    // Validate rental is in 'pending' status
    // Mark books as rented (ONLY when approved)
    // Update rental status to 'active'
    // Log the approval
}
```
**When it's called:**
- Admin/staff changes rental status from `pending` ‚Üí `active` in rentals.php
- Automatically triggers if status change is from pending to active
- Handles inventory updates at approval time

### 2. **rental_history.php** - User View

**Pending Rentals Section:**
- Shows rentals awaiting admin approval
- Yellow badge with ‚è≥ icon: "Pending"
- User can see they submitted the rental request
- Waiting for admin decision

**Active Rentals Section:**
- Shows approved rentals ready for pickup
- Blue badge: "Active"
- Shows days left before due date
- Ready for user to collect at store

### 3. **rentals.php** - Admin Management

**Enhanced Rental Approval Process:**
```php
// When admin changes status from 'pending' to 'active':
if ($currentRental['status'] === 'pending' && $newStatus === 'active') {
    $rentalModel->approveRental($rentalId);
    // Automatically marks books as rented
    Flash::add('success', 'Rental approved and inventory updated ‚úÖ');
}
```

**Features:**
- Detects status change from pending ‚Üí active
- Calls `approveRental()` to handle inventory
- Shows success message: "Rental approved and inventory updated"
- Prevents double booking by only decreasing inventory once

### 4. **Flash.php Helper** - Message Display

**Updated to support HTML:**
- Now allows HTML formatting in flash messages (was using `htmlspecialchars()`)
- Enables paragraph breaks and bold text in approval notifications
- Safe because messages are generated by system, not user input

### 5. **User Notification System**

**After Rental Submission:**
```
‚úÖ Book rented successfully!

‚ö†Ô∏è Please wait for admin approval.
Once approved, your rental will be ready for pickup at our store located at:
üìç Bookrent Store, 123 Main Street, City Center
```

**Features:**
- Clear explanation that rental is pending
- Store location provided for pickup
- Multiple lines with formatting for readability

---

## Data Flow

### User Renting a Book

```
1. User selects book and submits rental form
   ‚Üì
2. rentals.php POST handler calls RentalController->rent()
   ‚Üì
3. Rental->rentBook() creates rental with status='pending'
   ‚Üì
4. üìö Book inventory UNCHANGED (no markRented() call)
   ‚Üì
5. User sees: "Book rented successfully! Please wait for admin approval..."
   ‚Üì
6. Rental appears in rental_history.php under "Pending Rentals" section
```

### Admin Approving Rental

```
1. Admin views rentals.php ‚Üí sees pending rental
   ‚Üì
2. Admin changes status dropdown from "pending" to "active"
   ‚Üì
3. rentals.php detects status change: pending ‚Üí active
   ‚Üì
4. Calls Rental->approveRental($rentalId)
   ‚Üì
5. approveRental() marks book as rented (markRented() called here)
   ‚Üì
6. üìö Book inventory DECREASES by rental quantity
   ‚Üì
7. Rental status updated to 'active'
   ‚Üì
8. Admin sees: "Rental approved and inventory updated ‚úÖ"
   ‚Üì
9. Rental now appears in user's "Active Rentals" section
   ‚Üì
10. User notified ‚Üí ready to pick up at store
```

---

## Inventory Impact

### Before Implementation
```
Book XYZ available_copies: 5
User submits rental for 2 copies
immediately available_copies: 3 (even if pending!)
Problem: If admin rejects, manual correction needed
```

### After Implementation
```
Book XYZ available_copies: 5
User submits rental for 2 copies (pending)
available_copies: 5 (stays the same!)
‚úÖ Correct count while approval pending

Admin approves rental
available_copies: 3 (decreases AFTER approval)
‚úÖ Accurate inventory management
```

---

## Rental Status Workflow

```
User Submits Rental
        ‚Üì
    PENDING ‚Üê Awaiting admin approval (inventory intact)
        ‚Üì
Admin Approves [status ‚Üí active]
        ‚Üì
    ACTIVE ‚Üê Approved, ready for pickup (inventory decreased)
        ‚Üì
    ‚îú‚îÄ‚Üí RETURNED ‚Üê User returns book on time
    ‚îÇ        (inventory restored, no penalty)
    ‚îÇ
    ‚îî‚îÄ‚Üí OVERDUE ‚Üê User returns after due date
             (inventory restored, penalty applied)
```

---

## Files Modified

### Core Logic
1. **[src/Models/Rental.php](../src/Models/Rental.php)**
   - Removed `markRented()` from `rentBook()` method
   - Added new `approveRental($rentalId)` method
   - Updated comment explaining the workflow

2. **[public/rental_history.php](../public/rental_history.php)**
   - Displays 4 status sections: Pending, Active, Overdue, Returned
   - Pending section shows approval wait message

3. **[public/rentals.php](../public/rentals.php)**
   - Enhanced edit handler to detect pending ‚Üí active transition
   - Calls `approveRental()` when transitioning to active
   - Added Rental model import
   - Updated flash messages for approval context

4. **[src/Helpers/Flash.php](../src/Helpers/Flash.php)**
   - Removed `htmlspecialchars()` to allow HTML formatting
   - Supports `<br>` tags and `<strong>` tags in messages

---

## Testing Checklist

- [ ] User rents book ‚Üí rental created with `status='pending'`
- [ ] Book inventory stays same after rental submission
- [ ] Pending rental appears in rental_history.php "Pending Rentals" section
- [ ] User sees approval notification with store location
- [ ] Admin can view pending rental in rentals.php
- [ ] Admin changes status: pending ‚Üí active
- [ ] Book inventory decreases after approval
- [ ] Rental moves to "Active Rentals" in rental_history.php
- [ ] Approval notification shows in Flash message
- [ ] User can see approved rental is ready for pickup
- [ ] Admin can still manually change other fields (due_date, etc)

---

## Configuration Notes

**Store Location Message:**
Currently set to:
```
Bookrent Store, 123 Main Street, City Center
```

To customize, edit [public/rentals.php](../public/rentals.php) line ~45:
```php
Flash::add('success','Book rented successfully! ‚úÖ <br><br><strong>Please wait for admin approval.</strong> Once approved, your rental will be ready for pickup at our store located at: <strong>Bookrent Store, 123 Main Street, City Center</strong>');
```

---

## Admin Approval Benefits

‚úÖ **Prevents Overbooking**
- User can't instantly reduce inventory by requesting rental
- Only actual approved rentals affect stock counts

‚úÖ **Approval Control**
- Admin can review rental before it becomes active
- Can reject by deleting or not approving
- Can modify due dates before approval

‚úÖ **User Communication**
- Clear notification about waiting for approval
- Store location provided for pickup
- Status visible in rental history

‚úÖ **Inventory Accuracy**
- Available copies always reflects actual available books
- Audit trail of when inventory changed (approval time)
- Pending rentals don't inflate actual rental count

---

## Rollback Instructions

If you need to revert to immediate inventory decrease:

1. Edit [src/Models/Rental.php](../src/Models/Rental.php):
   - Uncomment `markRented()` call in `rentBook()` method
   - Remove call to `approveRental()` (or leave it unused)

2. Edit [public/rentals.php](../public/rentals.php):
   - Remove the approval check in edit handler
   - Revert to simple `Flash::add('success', 'Rental updated ‚úÖ')`

3. Edit [public/rental_history.php](../public/rental_history.php):
   - Remove pending rentals section or dismiss pending status

**Note:** Already-created pending rentals will stay pending. Admin must manually approve or delete them.

---

## Future Enhancements

- [ ] Auto-approve rentals after X hours (configurable)
- [ ] Send email notification to user when approved
- [ ] Prevent user from submitting multiple pending rentals
- [ ] Dashboard widget showing pending approvals count
- [ ] Scheduled cleanup of old pending rentals (7+ days old)
